<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Summernote Editor</title>

    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons CSS -->
    <link href="css/bootstrap-icons.min.css" rel="stylesheet" />

    <!-- Summernote CSS -->
    <link href="css/summernote-bs5.min.css" rel="stylesheet" />

    <style>
      body {
        margin: 0;
        padding: 16px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #ffffff;
      }

      .editor-container {
        height: calc(100vh - 32px);
        display: flex;
        flex-direction: column;
      }

      .note-editor {
        border: none !important;
        box-shadow: none !important;
        border-radius: 8px !important;
        overflow: hidden;
      }

      .note-toolbar {
        background: #f8fafc !important;
        border-bottom: 1px solid #e2e8f0 !important;
        padding: 8px 12px !important;
      }

      .note-editing-area {
        background: white;
      }

      .note-editable {
        min-height: 400px !important;
        padding: 16px !important;
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #1e293b !important;
        border: none !important;
        outline: none !important;
      }

      .note-editable:focus {
        outline: none !important;
      }

      .note-btn {
        border: none !important;
        border-radius: 4px !important;
        margin: 1px !important;
        background: transparent !important;
        color: #475569 !important;
      }

      .note-btn:hover {
        background: #e2e8f0 !important;
        color: #1e293b !important;
      }

      .note-btn.active {
        background: #2563eb !important;
        color: white !important;
      }

      .dropdown-menu {
        border: 1px solid #e2e8f0 !important;
        border-radius: 6px !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
      }

      .dropdown-item:hover {
        background: #f1f5f9 !important;
      }

      /* Hide some toolbar items for minimal setup */
      .note-btn-group.note-table,
      .note-btn-group.note-insert,
      .note-btn-group.note-view,
      .note-color,
      .note-para {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="editor-container">
      <div id="summernote"></div>
    </div>

    <!-- jQuery -->
    <script src="js/jquery.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="js/bootstrap.bundle.min.js"></script>

    <!-- Summernote JS -->
    <script src="js/summernote-bs5.min.js"></script>

    <script>
      let editorInitialized = false;
      let flutterReady = false;
      let scriptsLoaded = false;

      // Function to check if all required scripts are loaded
      function checkScriptsLoaded() {
        return (
          typeof $ !== "undefined" &&
          typeof bootstrap !== "undefined" &&
          $ &&
          $.fn &&
          $.fn.summernote
        );
      }

      // Function to wait for scripts to load
      function waitForScripts(callback, maxWait = 10000) {
        const startTime = Date.now();

        function check() {
          if (checkScriptsLoaded()) {
            scriptsLoaded = true;
            callback();
          } else if (Date.now() - startTime < maxWait) {
            setTimeout(check, 100);
          } else {
            console.error("Scripts failed to load within timeout");
            callback(); // Try anyway
          }
        }

        check();
      }

      // Function to notify Flutter when ready
      function notifyFlutterReady() {
        if (editorInitialized && flutterReady) {
          try {
            if (
              window.flutter_inappwebview &&
              window.flutter_inappwebview.callHandler
            ) {
              window.flutter_inappwebview.callHandler("editorReady");
              console.log("Flutter notified: editor ready");
            }
          } catch (error) {
            console.error("Error notifying Flutter:", error);
            // Fallback: try again after a short delay
            setTimeout(notifyFlutterReady, 100);
          }
        }
      }

      // Check if flutter_inappwebview is ready
      function checkFlutterReady() {
        if (
          window.flutter_inappwebview &&
          window.flutter_inappwebview.callHandler
        ) {
          flutterReady = true;
          notifyFlutterReady();
        } else {
          setTimeout(checkFlutterReady, 50);
        }
      }

      function initializeSummernote() {
        console.log("Initializing Summernote...");

        if (!checkScriptsLoaded()) {
          console.error("Required scripts not loaded");
          return;
        }

        try {
          $("#summernote").summernote({
            height: "calc(100vh - 120px)",
            minHeight: 300,
            placeholder: "Start typing...",
            focus: false,
            toolbar: [
              ["style", ["style"]],
              ["font", ["bold", "italic", "underline"]],
              // ["font", ["bold", "italic", "underline", "clear"]],
              // ["fontsize", ["fontsize"]],
              // ["para", ["ul", "ol", "paragraph"]],
              // ["height", ["height"]],
              // ["misc", ["undo", "redo"]],
            ],
            fontSizes: [
              "8",
              "9",
              "10",
              "11",
              "12",
              "14",
              "16",
              "18",
              "20",
              "22",
              "24",
              "28",
              "32",
              "36",
            ],
            callbacks: {
              onChange: function (contents, $editable) {
                try {
                  if (
                    window.flutter_inappwebview &&
                    window.flutter_inappwebview.callHandler
                  ) {
                    window.flutter_inappwebview.callHandler(
                      "contentChanged",
                      contents
                    );
                  }
                } catch (error) {
                  console.error("Error in onChange callback:", error);
                }
              },
              onInit: function () {
                console.log("Summernote initialized successfully");
                editorInitialized = true;
                notifyFlutterReady();
              },
              onFocus: function () {
                console.log("Editor focused");
              },
              onBlur: function () {
                console.log("Editor blurred");
              },
            },
          });

          // Start checking for Flutter readiness
          checkFlutterReady();
        } catch (error) {
          console.error("Error initializing Summernote:", error);
          // Fallback: mark as ready anyway
          editorInitialized = true;
          notifyFlutterReady();
        }
      }

      $(document).ready(function () {
        console.log("Document ready, waiting for scripts...");

        waitForScripts(function () {
          console.log("Scripts loaded, initializing...");
          initializeSummernote();
        });

        // Fallback: ensure editor is marked as ready after 5 seconds
        setTimeout(() => {
          if (!editorInitialized) {
            console.log("Fallback: marking editor as ready");
            editorInitialized = true;
            notifyFlutterReady();
          }
        }, 5000);

        // Global functions for Flutter integration
        window.getContent = function () {
          try {
            if (checkScriptsLoaded() && $("#summernote").length) {
              return $("#summernote").summernote("code");
            }
            return "";
          } catch (error) {
            console.error("Error getting content:", error);
            return "";
          }
        };

        window.setContent = function (content) {
          try {
            if (checkScriptsLoaded() && $("#summernote").length) {
              $("#summernote").summernote("code", content);
            }
          } catch (error) {
            console.error("Error setting content:", error);
          }
        };

        window.clearContent = function () {
          try {
            if (checkScriptsLoaded() && $("#summernote").length) {
              $("#summernote").summernote("reset");
            }
          } catch (error) {
            console.error("Error clearing content:", error);
          }
        };

        window.execCommand = function (command) {
          try {
            if (!checkScriptsLoaded() || !$("#summernote").length) {
              console.warn("Summernote not ready for command:", command);
              return;
            }

            switch (command) {
              case "bold":
                $("#summernote").summernote("bold");
                break;
              case "italic":
                $("#summernote").summernote("italic");
                break;
              case "underline":
                $("#summernote").summernote("underline");
                break;
              case "insertUnorderedList":
                $("#summernote").summernote("insertUnorderedList");
                break;
              case "insertOrderedList":
                $("#summernote").summernote("insertOrderedList");
                break;
              default:
                console.log("Unknown command:", command);
            }
          } catch (error) {
            console.error("Error executing command:", error);
          }
        };

        window.insertText = function (text) {
          try {
            if (checkScriptsLoaded() && $("#summernote").length) {
              $("#summernote").summernote("insertText", text);
            }
          } catch (error) {
            console.error("Error inserting text:", error);
          }
        };
      });
    </script>
  </body>
</html>
